---
title: "Estudio Longitudinal de las Relaciones Interculturales (ELRI)"
subtitle: "Centro de Estudios Interculturales e Indígenas (CIIR)"
authors: "Matías Deneken, Federico Díaz, Daniel Fuenzalida & Roberto González"
institute: "Matías Deneken, Federico Díaz, Daniel Fuenzalida & Roberto González"
date: today
format: 
  revealjs:
    theme: simple
    slide-number: true
    incremental: false
    fontsize: 28px
    margin: 0.3
    transition: fade
    controls: true
    controls-layout: bottom-right
    css: styles.css
    template-partials:
      - title-slide.html
    cite-method: citeproc
---

```{r setup, include=FALSE}
# ===============================================================================
# ELRI · Gráficos longitudinales por identidad, contacto y normas
# ===============================================================================

# 0) Librerías -------------------------------------------------------------------
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")

pacman::p_load(
  tidyverse, ggplot2, ggalluvial, viridis, RColorBrewer,
  patchwork, scales, here, glue, ggridges, haven, forcats, readr
)

library(dplyr)
library(rlang)

# --- NO ESCALAS: stubs y caption limpio ----------------------------------------
get_escala_info    <- function(...) NULL
get_escala_resumen <- function(...) ""
.build_caption     <- function(txt_fuente, ...) txt_fuente
CAPTION_FUENTE     <- "Fuente: Estudio Longitudinal de Relaciones Interculturales (2016–2023)"

# 1) Cargar base -----------------------------------------------------------------
load("../data/BBDD_ELRI_LONG.RData")
panel_data <- BBDD_ELRI_LONG

# 1B) Detectar columna ID y ola --------------------------------------------------
id_var <- dplyr::case_when(
  "folio"  %in% names(panel_data) ~ "folio",
  "ticket" %in% names(panel_data) ~ "ticket",
  "id"     %in% names(panel_data) ~ "id",
  TRUE ~ NA_character_
)
if (is.na(id_var)) stop("No encuentro columna ID (esperaba 'folio' / 'ticket' / 'id').")

wave_var <- dplyr::case_when(
  "ola"       %in% names(panel_data) ~ "ola",
  "wave_num"  %in% names(panel_data) ~ "wave_num",
  "fecha_ola" %in% names(panel_data) ~ "fecha_ola",
  TRUE ~ NA_character_
)
if (is.na(wave_var)) stop("No encuentro columna de ola (esperaba 'ola' / 'wave_num' / 'fecha_ola').")

id_sym   <- sym(id_var)
wave_sym <- sym(wave_var)

# 2) IDs con 4 olas -------------------------------------------------------------
ids_4olas <- panel_data %>%
  filter(!is.na(!!id_sym), !is.na(!!wave_sym)) %>%
  distinct(!!id_sym, !!wave_sym) %>%
  count(!!id_sym, name = "n_olas") %>%
  filter(n_olas == 4) %>%
  pull(!!id_sym)

panel_data <- panel_data %>%
  filter((!!id_sym) %in% ids_4olas)

# 3) Helpers básicos -------------------------------------------------------------

# 3.1) Invertir escala 1–5 (1↔5, 2↔4, 3→3)
invertir_1a5 <- function(x) {
  v <- haven::zap_labels(x) |> suppressWarnings(as.numeric())
  invalid <- v %in% c(66,77,88,99,666,777,888,999,8888,9999)
  v[invalid] <- NA_real_
  v[!(v %in% 1:5)] <- NA_real_
  dplyr::case_when(
    v == 1 ~ 5,
    v == 2 ~ 4,
    v == 3 ~ 3,
    v == 4 ~ 2,
    v == 5 ~ 1,
    TRUE   ~ NA_real_
  )
}

# 3.2) Limpieza Likert 1–5
likert_clean <- function(x) {
  x2 <- haven::zap_labels(x) |> suppressWarnings(as.numeric())
  invalid <- x2 %in% c(66, 77, 88, 99, 666, 777, 888, 999, 8888, 9999)
  x2[invalid] <- NA_real_
  x2[!(x2 %in% 1:5)] <- NA_real_
  x2
}

# 3.3) Tamaño global para slides ------------------------------------------------
knitr::opts_chunk$set(
  fig.width  = 13.33,  # ~1400 px
  fig.height = 7.5,    # ~800 px
  dpi        = 105,
  dev        = "png",
  out.width  = "100%",
  fig.align  = "center",
  echo = FALSE, warning = FALSE, message = FALSE
)

# 4) Preparar base: ola, identidad y A2 invertida -------------------------------
a2_vars <- c("a2_1","a2_2","a2_3","a2_4","a2_5")

panel_data <- panel_data %>%
  mutate(
    across(all_of(a2_vars), invertir_1a5),
    ola_chr   = as.character(ola),
    fecha_ola = dplyr::recode(ola_chr,
                              "1" = "2016",
                              "2" = "2018",
                              "3" = "2021",
                              "4" = "2023",
                              .default = NA_character_),
    wave_num  = readr::parse_integer(ola_chr, na = c("", "NA")),
    a1_num    = haven::zap_labels(a1) |> suppressWarnings(as.numeric(.)),
    cat_indi  = dplyr::case_when(
      a1_num %in% 1:11 ~ "Indígena",
      a1_num == 12    ~ "No indígena",
      TRUE            ~ NA_character_
    )
  ) %>%
  filter(!is.na(fecha_ola), !is.na(cat_indi)) %>%
  mutate(
    cat_indi  = factor(cat_indi, levels = c("Indígena", "No indígena")),
    fecha_ola = factor(fecha_ola, levels = c("2016","2018","2021","2023"))
  ) %>%
  group_by(!!id_sym) %>%
  filter(n_distinct(fecha_ola) == 4,
         n_distinct(cat_indi) == 1) %>%
  ungroup()

# 5) Tema gráfico y paleta identidad -------------------------------------------
theme_esep_longitudinal <- function() {
  theme_minimal(base_family = "Arial") +
    theme(
      plot.title.position = "plot",
      plot.title    = element_text(size = 22, face = "bold", hjust = 0.5, margin = margin(b = 10)),
      plot.subtitle = element_text(size = 18, hjust = 0.5, color = "#555555", margin = margin(b = 15)),
      axis.title    = element_text(size = 15, face = "bold"),
      axis.text     = element_text(size = 14, color = "#333"),
      legend.title  = element_text(size = 16, face = "bold"),
      legend.text   = element_text(size = 16),
      strip.text    = element_text(size = 15, face = "bold"),
      panel.grid.major = element_line(color = "#f0f0f0", size = 0.5),
      panel.grid.minor = element_blank(),
      legend.position  = "bottom",
      plot.caption  = element_text(size = 12, color = "#777", margin = margin(t = 10, b = 8)),
      plot.margin   = margin(t = 10, r = 30, b = 24, l = 10)
    )
}
theme_set(theme_esep_longitudinal())

pal_identidad <- c("Indígena" = "#D81B60", "No indígena" = "#1E88E5")
scale_fill_identidad  <- function(label = "Identidad") scale_fill_manual(values = pal_identidad, name = label, drop = FALSE)
scale_color_identidad <- function(label = "Identidad") scale_color_manual(values = pal_identidad, name = label, drop = FALSE)
legend_identidad <- function() {
  guides(color = guide_legend(override.aes = list(linetype = 1, size = 1.6), title = "Identidad"),
         fill  = "none")
}

# 6) Etiquetas y grupos temáticos ----------------------------------------------
var_labels <- c(
  "a4"    = "Identificación con los pueblos originarios",
  "a6"    = "Identificación con Chile",
  "a2_1"  = "Para definirse como indígena: Que hable la lengua de su Pueblo Originario",
  "a2_3"  = "Para definirse como indígena: Que participe en ritos y ceremonias",
  "a2_4"  = "Para definirse como indígena: Que viva en una comunidad",
  "a2_5"  = "Para definirse como indígena: Que tenga algún apellido indígena",
  "c1"    = "Simpatía hacia chilenos no indígenas",
  "c4"    = "Simpatía hacia chilenos indígenas",
  "c2"    = "Confianza en chilenos no indígenas",
  "c5"    = "Confianza en chilenos indígenas",
  "c17_2" = "Importa entender el punto de vista de los Pueblos Originarios",
  "c17_4" = "Importa entender el punto de vista de los no indígenas",
  "c19"   = "Percepción de diferencia entre grupos",
  "c22"   = "Condiciones de vida indígenas son peores",
  "c26_1" = "Mi familia valora que yo tenga amigos de Pueblos Originarios",
  "c26_2" = "Mi familia valora que yo tenga amigos No Indígenas",
  "c27_1" = "En Chile se respeta a los Pueblos Originarios",
  "c27_2" = "La imagen de Pueblos Originarios es positiva",
  "c32_1" = "Firmar cartas de apoyo a causas indígenas",
  "c32_2" = "Protestar por causas indígenas",
  "c35"   = "La sangre indígena define nuestras vidas",
  "d1_1"  = "Conflicto: Estado vs Pueblos Indígenas",
  "d1_2"  = "Conflicto: indígenas vs no indígenas",
  "d2_3"  = "El conflicto genera inseguridad en el país",
  "d5_1"  = "Carabineros respetan a personas indígenas",
  "d5_2"  = "Carabineros respetan a no indígenas",
  "d6_1"  = "Me siento identificado con la causa indígena",
  "d6_2"  = "Me siento comprometido con la causa indígena",
  "d3_1"  = "Uso de la fuerza de Carabineros para disolver protestas",
  "d3_2"  = "Agricultores usen armas para enfrentarse",
  "d4_2"  = "Que grupos de personas indígenas se tomen terrenos",
  "d4_3"  = "El bloqueo de carreteras por parte de grupos indígenas",
  "e3_1"  = "Los Mapuche debiesen establecer un Estado Independiente, separado de Chile",
  "e3_2"  = "Debiese existir autonomía territorial indígena dentro del estado chileno",
  "e3_2"  = "Autonomía territorial indígena dentro del Estado",
  "e3_3"  = "Justicia considera tradiciones y costumbres indígenas",
  "e3_5"  = "Es justo que a los indígenas se les asigne un puntaje especial mayor para acceder a beneficios sociales",
  "e4_4"  = "Restituir tierras a los pueblos indígenas",
  "e4_5"  = "Escaños reservados indígenas en el Congreso"
)

label_var <- function(v) {
  if (exists("var_labels") && v %in% names(var_labels)) {
    lab <- var_labels[[v]]
    if (!is.null(lab) && nzchar(lab)) return(as.character(lab))
  }
  if (v %in% names(panel_data)) {
    lab_attr <- attr(panel_data[[v]], "label", exact = TRUE)
    if (!is.null(lab_attr) && nzchar(lab_attr)) return(as.character(lab_attr))
  }
  as.character(v)
}

e_all <- names(panel_data)[grepl("^e\\d+_", names(panel_data))]

grupos_tematicos <- list(
  "Identificación"                 = c("a4", "a6"),
  "Afecto intergrupal"             = c("c1", "c4"),
  "Confianza intergrupal"          = c("c2", "c5"),
  "Diferencia y desigualdad"       = c("c19", "c22"),
  "Valores/actitudes simbólicas"   = c("c17_2", "c17_4", "c26_1", "c26_2", "c27_1", "c27_2", "c35"),
  "Participación cívica"           = c("c32_1", "c32_2"),
  "Percepción de conflicto"        = c("d1_1", "d1_2"),
  "Confianza institucional"        = c("d2_3", "d5_1", "d5_2"),
  "Justificación de la violencia"  = c("d3_1","d3_2","d4_2","d4_3"),
  "Bloque E (todas)"               = e_all
)
vars_de_tema  <- function(tema) {
  if (!tema %in% names(grupos_tematicos))
    stop("Tema no reconocido. Usa: ", paste(names(grupos_tematicos), collapse = " | "))
  grupos_tematicos[[tema]]
}
listar_temas  <- function() names(grupos_tematicos)

violencia_vars <- c("d3_1","d3_2","d4_2","d4_3")

# 7) Variables de contacto y normas ---------------------------------------------
panel_data <- panel_data %>%
  mutate(
    c26_1_num = likert_clean(c26_1),
    c26_2_num = likert_clean(c26_2),
    c6_1_num  = likert_clean(c6_1),
    c6_2_num  = likert_clean(c6_2),
    c7_1_num  = likert_clean(c7_1),
    c7_2_num  = likert_clean(c7_2)
  ) %>%
  mutate(
    # CONTACTO y NORMA por grupo específico
    contacto_indi_bin = case_when(
      c6_1_num %in% 4:5 | c6_2_num %in% 4:5 ~ 1L,
      c6_1_num %in% 1:2 & c6_2_num %in% 1:2 ~ 0L,
      TRUE                                  ~ NA_integer_
    ),
    contacto_noindi_bin = case_when(
      c7_1_num %in% 4:5 | c7_2_num %in% 4:5 ~ 1L,
      c7_1_num %in% 1:2 & c7_2_num %in% 1:2 ~ 0L,
      TRUE                                  ~ NA_integer_
    ),
    norma_indi_bin = case_when(
      c26_1_num %in% 4:5 ~ 1L,
      c26_1_num %in% 1:2 ~ 0L,
      TRUE               ~ NA_integer_
    ),
    norma_noindi_bin = case_when(
      c26_2_num %in% 4:5 ~ 1L,
      c26_2_num %in% 1:2 ~ 0L,
      TRUE               ~ NA_integer_
    ),
    
    contacto_indi_cat = factor(
      case_when(
        contacto_indi_bin == 1L ~ "Alto contacto indígenas",
        contacto_indi_bin == 0L ~ "Bajo contacto indígenas",
        TRUE                    ~ NA_character_
      ),
      levels = c("Bajo contacto indígenas", "Alto contacto indígenas")
    ),
    contacto_noindi_cat = factor(
      case_when(
        contacto_noindi_bin == 1L ~ "Alto contacto no indígenas",
        contacto_noindi_bin == 0L ~ "Bajo contacto no indígenas",
        TRUE                      ~ NA_character_
      ),
      levels = c("Bajo contacto no indígenas", "Alto contacto no indígenas")
    ),
    norma_indi_cat = factor(
      case_when(
        norma_indi_bin == 1L ~ "Norma alta amigos indígenas",
        norma_indi_bin == 0L ~ "Norma baja amigos indígenas",
        TRUE                 ~ NA_character_
      ),
      levels = c("Norma baja amigos indígenas", "Norma alta amigos indígenas")
    ),
    norma_noindi_cat = factor(
      case_when(
        norma_noindi_bin == 1L ~ "Norma alta amigos no indígenas",
        norma_noindi_bin == 0L ~ "Norma baja amigos no indígenas",
        TRUE                   ~ NA_character_
      ),
      levels = c("Norma baja amigos no indígenas", "Norma alta amigos no indígenas")
    ),
    
    # Versión ingroup / outgroup segun cat_indi
    contacto_ingroup_bin = case_when(
      cat_indi == "Indígena"    ~ contacto_indi_bin,
      cat_indi == "No indígena" ~ contacto_noindi_bin,
      TRUE                      ~ NA_integer_
    ),
    contacto_outgroup_bin = case_when(
      cat_indi == "Indígena"    ~ contacto_noindi_bin,
      cat_indi == "No indígena" ~ contacto_indi_bin,
      TRUE                      ~ NA_integer_
    ),
    norma_ingroup_bin = case_when(
      cat_indi == "Indígena"    ~ norma_indi_bin,
      cat_indi == "No indígena" ~ norma_noindi_bin,
      TRUE                      ~ NA_integer_
    ),
    norma_outgroup_bin = case_when(
      cat_indi == "Indígena"    ~ norma_noindi_bin,
      cat_indi == "No indígena" ~ norma_indi_bin,
      TRUE                      ~ NA_integer_
    ),
    
    contacto_ingroup_cat = factor(
      case_when(
        contacto_ingroup_bin == 1L ~ "Alto contacto ingroup",
        contacto_ingroup_bin == 0L ~ "Bajo contacto ingroup",
        TRUE                       ~ NA_character_
      ),
      levels = c("Bajo contacto ingroup", "Alto contacto ingroup")
    ),
    contacto_outgroup_cat = factor(
      case_when(
        contacto_outgroup_bin == 1L ~ "Alto contacto outgroup",
        contacto_outgroup_bin == 0L ~ "Bajo contacto outgroup",
        TRUE                        ~ NA_character_
      ),
      levels = c("Bajo contacto outgroup", "Alto contacto outgroup")
    ),
    norma_ingroup_cat = factor(
      case_when(
        norma_ingroup_bin == 1L ~ "Norma alta ingroup",
        norma_ingroup_bin == 0L ~ "Norma baja ingroup",
        TRUE                    ~ NA_character_
      ),
      levels = c("Norma baja ingroup", "Norma alta ingroup")
    ),
    norma_outgroup_cat = factor(
      case_when(
        norma_outgroup_bin == 1L ~ "Norma alta outgroup",
        norma_outgroup_bin == 0L ~ "Norma baja outgroup",
        TRUE                     ~ NA_character_
      ),
      levels = c("Norma baja outgroup", "Norma alta outgroup")
    ),
    
    # Perfil 4 categorías ingroup/outgroup
    perfil_contacto_io = factor(
      case_when(
        contacto_ingroup_bin == 0L & contacto_outgroup_bin == 0L ~ "Bajo ingroup / Bajo outgroup",
        contacto_ingroup_bin == 0L & contacto_outgroup_bin == 1L ~ "Bajo ingroup / Alto outgroup",
        contacto_ingroup_bin == 1L & contacto_outgroup_bin == 0L ~ "Alto ingroup / Bajo outgroup",
        contacto_ingroup_bin == 1L & contacto_outgroup_bin == 1L ~ "Alto ingroup / Alto outgroup",
        TRUE ~ NA_character_
      ),
      levels = c(
        "Bajo ingroup / Bajo outgroup",
        "Bajo ingroup / Alto outgroup",
        "Alto ingroup / Bajo outgroup",
        "Alto ingroup / Alto outgroup"
      )
    ),
    
    # Cruces identidad × contacto (para barras)
    cruce_contacto_ingroup = factor(
      case_when(
        cat_indi == "Indígena"    & contacto_ingroup_cat == "Alto contacto ingroup" ~ "Indígena – Alto contacto ingroup",
        cat_indi == "Indígena"    & contacto_ingroup_cat == "Bajo contacto ingroup" ~ "Indígena – Bajo contacto ingroup",
        cat_indi == "No indígena" & contacto_ingroup_cat == "Alto contacto ingroup" ~ "No indígena – Alto contacto ingroup",
        cat_indi == "No indígena" & contacto_ingroup_cat == "Bajo contacto ingroup" ~ "No indígena – Bajo contacto ingroup",
        TRUE ~ NA_character_
      ),
      levels = c(
        "Indígena – Bajo contacto ingroup",
        "Indígena – Alto contacto ingroup",
        "No indígena – Bajo contacto ingroup",
        "No indígena – Alto contacto ingroup"
      )
    ),
    cruce_contacto_outgroup = factor(
      case_when(
        cat_indi == "Indígena"    & contacto_outgroup_cat == "Alto contacto outgroup" ~ "Indígena – Alto contacto outgroup",
        cat_indi == "Indígena"    & contacto_outgroup_cat == "Bajo contacto outgroup" ~ "Indígena – Bajo contacto outgroup",
        cat_indi == "No indígena" & contacto_outgroup_cat == "Alto contacto outgroup" ~ "No indígena – Alto contacto outgroup",
        cat_indi == "No indígena" & contacto_outgroup_cat == "Bajo contacto outgroup" ~ "No indígena – Bajo contacto outgroup",
        TRUE ~ NA_character_
      ),
      levels = c(
        "Indígena – Bajo contacto outgroup",
        "Indígena – Alto contacto outgroup",
        "No indígena – Bajo contacto outgroup",
        "No indígena – Alto contacto outgroup"
      )
    )
  )

# 8) Agregadores -----------------------------------------------------------------

# 8.1) Top-box 4–5 por identidad
agg_pct_top <- function(df, var, min_n = 20) {
  regla_pos <- function(v, valor)
    if (v %in% violencia_vars) valor %in% 3:5 else valor %in% 4:5
  
  df %>%
    select(wave_num, fecha_ola, cat_indi, !!sym(var)) %>%
    mutate(
      valor = likert_clean(.data[[var]]),
      grupo = cat_indi,
      pos   = ifelse(regla_pos(var, valor), 1, 0)
    ) %>%
    filter(!is.na(pos)) %>%
    group_by(wave_num, fecha_ola, grupo) %>%
    summarise(p = mean(pos, na.rm = TRUE),
              n = n(), .groups = "drop") %>%
    filter(n >= min_n) %>%
    mutate(
      porcentaje = p * 100,
      se_pct     = sqrt(p * (1 - p) / n) * 100,
      lo         = pmax(0, porcentaje - 1.96 * se_pct),
      hi         = pmin(100, porcentaje + 1.96 * se_pct),
      fecha_ola  = factor(as.character(fecha_ola), levels = c("2016","2018","2021","2023")),
      grupo      = fct_drop(grupo)
    )
}

# 8.2) Top-box 4–5 por identidad + (alto/bajo contacto o norma) ------------------
agg_pct_top_contact <- function(df, var, bin_var, cat_var, min_n = 20) {
  regla_pos_local <- function(v, valor)
    if (v %in% violencia_vars) valor %in% 3:5 else valor %in% 4:5
  
  df %>%
    select(wave_num, fecha_ola, cat_indi,
           !!sym(var), !!sym(bin_var), !!sym(cat_var)) %>%
    mutate(
      valor    = likert_clean(.data[[var]]),
      nivel_bin = .data[[bin_var]],
      nivel_cat = .data[[cat_var]],
      grupo    = cat_indi,
      pos      = ifelse(regla_pos_local(var, valor), 1, 0)
    ) %>%
    filter(!is.na(pos), !is.na(nivel_cat)) %>%
    group_by(wave_num, fecha_ola, grupo, nivel_cat) %>%
    summarise(p = mean(pos, na.rm = TRUE),
              n = n(), .groups = "drop") %>%
    filter(n >= min_n) %>%
    mutate(
      porcentaje = p * 100,
      se_pct     = sqrt(p * (1 - p) / n) * 100,
      lo         = pmax(0, porcentaje - 1.96 * se_pct),
      hi         = pmin(100, porcentaje + 1.96 * se_pct),
      fecha_ola  = factor(as.character(fecha_ola), levels = c("2016","2018","2021","2023")),
      grupo      = fct_drop(grupo),
      nivel_cat  = fct_drop(nivel_cat)
    )
}

# 8.3) Validación de variables ---------------------------------------------------
validar_vars <- function(vars) {
  presentes <- intersect(vars, names(panel_data))
  faltantes <- setdiff(vars, names(panel_data))
  if (length(faltantes) > 0)
    warning("Se omitieron variables no encontradas: ", paste(faltantes, collapse = ", "))
  if (length(presentes) == 0)
    stop("Ninguna de las variables existe en 'panel_data'.")
  presentes
}

# 9) GRÁFICOS POR IDENTIDAD (barras / líneas) -----------------------------------

# 9.1) Barras · 1 variable
plot_variable_por_indigeneidad <- function(variable, titulo_variable = NULL, min_n = 20) {
  if (!variable %in% names(panel_data)) { warning("Variable no encontrada: ", variable); return(NULL) }
  if (is.null(titulo_variable)) titulo_variable <- label_var(variable)
  tendencias <- agg_pct_top(panel_data, variable, min_n = min_n)
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  
  ggplot(tendencias, aes(x = fecha_ola, y = porcentaje, fill = grupo)) +
    geom_col(position = position_dodge(width = 0.8),
             color = "white", width = 0.7, size = 0.8) +
    geom_text(aes(label = paste0(round(porcentaje), "%")),
              position = position_dodge(width = 0.8),
              vjust = -0.6, color = "black", fontface = "bold", size = 5) +
    scale_y_continuous(labels = \(x) paste0(x, "%"),
                       limits = c(0,100), breaks = seq(0,100,20),
                       expand = expansion(mult = c(0, 0.05))) +
    scale_fill_identidad("Identidad") +
    labs(
      title = titulo_variable,
      subtitle = "Cruce por pertenencia: Indígena vs No indígena",
      x = "Olas de seguimiento", y = "Porcentaje (top-box 4–5)",
      caption = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal()
}

# 9.2) Barras · varias variables (facet)
plot_variables_por_indigeneidad <- function(variables, titulo = NULL, min_n = 20, ncol = 2) {
  variables <- validar_vars(variables)
  if (is.null(titulo)) titulo <- paste("Ítems:", paste(variables, collapse = ", "))
  
  tendencias <- purrr::map_dfr(variables, ~{
    tmp <- agg_pct_top(panel_data, .x, min_n = min_n)
    if (nrow(tmp) == 0) return(tmp)
    tmp$variable <- factor(.x, levels = variables, labels = purrr::map_chr(variables, label_var))
    tmp
  })
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  
  ggplot(tendencias, aes(x = fecha_ola, y = porcentaje, fill = grupo)) +
    geom_col(position = position_dodge(width = 0.8),
             color = "white", width = 0.7, size = 0.8) +
    geom_text(aes(label = paste0(round(porcentaje), "%")),
              position = position_dodge(width = 0.8),
              vjust = -0.6, color = "black", fontface = "bold", size = 4.2) +
    scale_y_continuous(labels = \(x) paste0(x, "%"),
                       limits = c(0,100), breaks = seq(0,100,20),
                       expand = expansion(mult = c(0, 0.05))) +
    scale_fill_identidad("Identidad") +
    labs(
      title = titulo,
      subtitle = "Cruce por pertenencia: Indígena vs No indígena",
      x = "Olas de seguimiento", y = "Porcentaje (top-box 4–5)",
      caption = CAPTION_FUENTE
    ) +
    facet_wrap(~ variable, ncol = ncol) +
    theme_esep_longitudinal()
}

# 9.3) Líneas · 1 variable
plot_variable_por_indigeneidad_line <- function(variable, titulo_variable = NULL,
                                                min_n = 20, ci = FALSE, annotate_end = TRUE) {
  if (!variable %in% names(panel_data)) { warning("Variable no encontrada: ", variable); return(NULL) }
  if (is.null(titulo_variable)) titulo_variable <- label_var(variable)
  
  tendencias <- agg_pct_top(panel_data, variable, min_n = min_n)
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  tendencias <- tendencias %>% mutate(x_num = as.numeric(fecha_ola))
  
  last_lvl_chr <- levels(tendencias$fecha_ola)[length(levels(tendencias$fecha_ola))]
  labels_mid <- dplyr::filter(tendencias, as.character(fecha_ola) != last_lvl_chr)
  end_lab <- tendencias %>%
    dplyr::filter(as.character(fecha_ola) == last_lvl_chr) %>%
    dplyr::group_by(grupo) %>% dplyr::slice_tail(n = 1) %>% dplyr::ungroup()
  
  ggplot(tendencias, aes(x = x_num, y = porcentaje, group = grupo, color = grupo)) +
    (if (ci) geom_ribbon(aes(ymin = lo, ymax = hi, fill = grupo), alpha = 0.15) else NULL) +
    geom_line(linewidth = 1.8, lineend = "round") +
    geom_text(data = labels_mid, aes(label = paste0(round(porcentaje), "%")),
              vjust = -0.9, size = 4.5, show.legend = FALSE) +
    (if (annotate_end)
      geom_text(data = end_lab,
                aes(x = max(tendencias$x_num), y = porcentaje,
                    label = paste0(round(porcentaje), "%"), color = grupo),
                inherit.aes = FALSE, hjust = -0.1, vjust = 0.5, size = 5, fontface = "bold") else NULL) +
    scale_x_continuous(breaks = sort(unique(tendencias$x_num)),
                       labels = levels(tendencias$fecha_ola)) +
    scale_y_continuous(labels = \(x) paste0(x, "%"),
                       limits = c(0,100), breaks = seq(0,100,20),
                       expand = expansion(mult = c(0.04, 0.12))) +
    scale_color_identidad("Identidad") + (if (ci) scale_fill_identidad("Identidad") else NULL) +
    legend_identidad() + coord_cartesian(clip = "off") +
    labs(
      title = titulo_variable,
      subtitle = "Cruce por pertenencia: Indígena vs No indígena",
      x = "Olas de seguimiento", y = "Porcentaje (top-box 4–5)",
      caption = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal()
}

# 9.4) Líneas · varias variables (facet)
plot_variables_por_indigeneidad_line <- function(variables, titulo = NULL, min_n = 20,
                                                 ci = FALSE, annotate_end = TRUE, ncol = 2) {
  variables <- validar_vars(variables)
  if (is.null(titulo)) titulo <- paste("Ítems:", paste(variables, collapse = ", "))
  
  tendencias <- purrr::map_dfr(variables, ~{
    tmp <- agg_pct_top(panel_data, .x, min_n = min_n)
    if (nrow(tmp) == 0) return(tmp)
    tmp$variable <- factor(.x, levels = variables,
                           labels = purrr::map_chr(variables, label_var))
    tmp
  })
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  tendencias <- tendencias %>% mutate(x_num = as.numeric(fecha_ola))
  
  last_lvl_chr <- levels(tendencias$fecha_ola)[length(levels(tendencias$fecha_ola))]
  labels_mid <- dplyr::filter(tendencias, as.character(fecha_ola) != last_lvl_chr)
  end_lab <- tendencias %>%
    dplyr::filter(as.character(fecha_ola) == last_lvl_chr) %>%
    dplyr::group_by(variable, grupo) %>% dplyr::slice_tail(n = 1) %>% dplyr::ungroup()
  
  ggplot(tendencias, aes(x = x_num, y = porcentaje, group = grupo, color = grupo)) +
    (if (ci) geom_ribbon(aes(ymin = lo, ymax = hi, fill = grupo), alpha = 0.15) else NULL) +
    geom_line(linewidth = 1.8, lineend = "round") +
    geom_text(data = labels_mid, aes(label = paste0(round(porcentaje), "%")),
              vjust = -0.9, size = 4, show.legend = FALSE) +
    (if (annotate_end)
      geom_text(data = end_lab,
                aes(x = max(tendencias$x_num), y = porcentaje,
                    label = paste0(round(porcentaje), "%"), color = grupo),
                inherit.aes = FALSE, hjust = -0.1, vjust = 0.5, size = 4.3, fontface = "bold") else NULL) +
    scale_x_continuous(breaks = sort(unique(tendencias$x_num)),
                       labels = levels(tendencias$fecha_ola)) +
    scale_y_continuous(labels = \(x) paste0(x, "%"),
                       limits = c(0,100), breaks = seq(0,100,20),
                       expand = expansion(mult = c(0.04, 0.12))) +
    scale_color_identidad("Identidad") + (if (ci) scale_fill_identidad("Identidad") else NULL) +
    legend_identidad() + coord_cartesian(clip = "off") +
    labs(
      title = titulo,
      subtitle = "Cruce por pertenencia: Indígena vs No indígena",
      x = "Olas de seguimiento", y = "Porcentaje (top-box 4–5)",
      caption = CAPTION_FUENTE
    ) +
    facet_wrap(~ variable, ncol = ncol) +
    theme_esep_longitudinal()
}

# 10) GRÁFICOS LONGITUDINALES POR CONTACTO / NORMA ------------------------------

# 10.1) Contacto: facet alto/bajo, líneas = identidad
# contacto = "ingroup" / "outgroup" / "indi" / "noindi"
# 17B) LÍNEAS: efecto del contacto (facet = alto/bajo)
# contacto = "ingroup"  / "outgroup" / "indi" / "noindi"
# grupo_filtro = "Ambos" / "Indígena" / "No indígena"
# 10.1) Contacto: facet alto/bajo, líneas = identidad
# contacto = "ingroup" / "outgroup" / "indi" / "noindi"
# grupo_filtro = "Ambos" / "Indígena" / "No indígena"
plot_variable_por_contacto_line <- function(variable,
                                            contacto = c("ingroup","outgroup",
                                                         "indi","noindi"),
                                            titulo_variable = NULL,
                                            min_n = 20,
                                            ci = FALSE,
                                            grupo_filtro = c("Ambos","Indígena","No indígena")) {
  
  contacto     <- match.arg(contacto)
  grupo_filtro <- match.arg(grupo_filtro)
  
  if (!variable %in% names(panel_data)) {
    warning("Variable no encontrada: ", variable)
    return(NULL)
  }
  if (is.null(titulo_variable)) titulo_variable <- label_var(variable)
  
  # qué variable de contacto usar según opción
  info <- switch(
    contacto,
    "ingroup" = list(
      bin_var = "contacto_ingroup_bin",
      cat_var = "contacto_ingroup_cat",
      subt    = "Contacto con el propio grupo (ingroup)"
    ),
    "outgroup" = list(
      bin_var = "contacto_outgroup_bin",
      cat_var = "contacto_outgroup_cat",
      subt    = "Contacto con el otro grupo (outgroup)"
    ),
    "indi" = list(
      bin_var = "contacto_indi_bin",
      cat_var = "contacto_indi_cat",
      subt    = "Contacto con indígenas"
    ),
    "noindi" = list(
      bin_var = "contacto_noindi_bin",
      cat_var = "contacto_noindi_cat",
      subt    = "Contacto con no indígenas"
    )
  )
  
  # ⬇️ llamada consistente con agg_pct_top_contact(df, var, bin_var, cat_var, ...)
  tendencias <- agg_pct_top_contact(
    df      = panel_data,
    var     = variable,
    bin_var = info$bin_var,
    cat_var = info$cat_var,
    min_n   = min_n
  )
  
  if (nrow(tendencias) == 0) {
    warning("Sin datos suficientes.")
    return(NULL)
  }
  
  # filtro opcional por identidad
  if (grupo_filtro != "Ambos") {
    tendencias <- tendencias %>%
      dplyr::filter(grupo == grupo_filtro) %>%
      droplevels()
  }
  
  tendencias <- tendencias %>%
    mutate(x_num = as.numeric(fecha_ola))
  
  subt_extra <- if (grupo_filtro == "Ambos") "" else paste0(" (solo ", grupo_filtro, ")")
  
  ggplot(tendencias,
         aes(x = x_num, y = porcentaje,
             group = grupo, color = grupo)) +
    (if (ci)
      geom_ribbon(aes(ymin = lo, ymax = hi, fill = grupo),
                  alpha = 0.15, colour = NA) else NULL) +
    geom_line(linewidth = 1.8, lineend = "round") +
    geom_text(aes(label = paste0(round(porcentaje), "%")),
              vjust = -0.9, size = 4, show.legend = FALSE) +
    scale_x_continuous(
      breaks = sort(unique(tendencias$x_num)),
      labels = levels(tendencias$fecha_ola)
    ) +
    scale_y_continuous(
      labels = \(x) paste0(x, "%"),
      limits = c(0, 100),
      breaks = seq(0, 100, 20),
      expand = expansion(mult = c(0.04, 0.12))
    ) +
    scale_color_identidad("Identidad") +
    (if (ci) scale_fill_identidad("Identidad") else NULL) +
    legend_identidad() +
    coord_cartesian(clip = "off") +
    facet_wrap(~ nivel_cat, ncol = 2) +   # <-- usa nivel_cat, que es lo que devuelve el agg
    labs(
      title    = titulo_variable,
      subtitle = glue("{info$subt}: alto vs bajo contacto{subt_extra}"),
      x        = "Olas de seguimiento",
      y        = "Porcentaje (top-box 4–5)",
      caption  = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal()
}



# 10.2) Norma: facet alta/baja, líneas = identidad
# norma = "ingroup" / "outgroup" / "indi" / "noindi"
plot_variable_por_norma_line <- function(variable,
                                         norma = c("ingroup","outgroup","indi","noindi"),
                                         titulo_variable = NULL,
                                         min_n = 20,
                                         ci = FALSE) {
  
  norma <- match.arg(norma)
  if (!variable %in% names(panel_data)) { warning("Variable no encontrada: ", variable); return(NULL) }
  if (is.null(titulo_variable)) titulo_variable <- label_var(variable)
  
  info <- switch(norma,
                 "ingroup"  = list(bin = "norma_ingroup_bin",  cat = "norma_ingroup_cat",
                                   subt = "Norma familiar respecto al propio grupo (ingroup)"),
                 "outgroup" = list(bin = "norma_outgroup_bin", cat = "norma_outgroup_cat",
                                   subt = "Norma familiar respecto al otro grupo (outgroup)"),
                 "indi"     = list(bin = "norma_indi_bin",     cat = "norma_indi_cat",
                                   subt = "Norma: amigos indígenas"),
                 "noindi"   = list(bin = "norma_noindi_bin",   cat = "norma_noindi_cat",
                                   subt = "Norma: amigos no indígenas")
  )
  
  tendencias <- agg_pct_top_contact(
    df      = panel_data,
    var     = variable,
    bin_var = info$bin,
    cat_var = info$cat,
    min_n   = min_n
  )
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  
  tendencias <- tendencias %>% mutate(x_num = as.numeric(fecha_ola))
  
  ggplot(tendencias,
         aes(x = x_num, y = porcentaje,
             group = grupo, color = grupo)) +
    (if (ci)
      geom_ribbon(aes(ymin = lo, ymax = hi, fill = grupo),
                  alpha = 0.15, colour = NA) else NULL) +
    geom_line(linewidth = 1.8, lineend = "round") +
    geom_text(aes(label = paste0(round(porcentaje), "%")),
              vjust = -0.9, size = 4, show.legend = FALSE) +
    scale_x_continuous(
      breaks = sort(unique(tendencias$x_num)),
      labels = levels(tendencias$fecha_ola)
    ) +
    scale_y_continuous(
      labels = \(x) paste0(x, "%"),
      limits = c(0, 100),
      breaks = seq(0, 100, 20),
      expand = expansion(mult = c(0.04, 0.12))
    ) +
    scale_color_identidad("Identidad") +
    (if (ci) scale_fill_identidad("Identidad") else NULL) +
    legend_identidad() +
    coord_cartesian(clip = "off") +
    facet_wrap(~ nivel_cat, ncol = 2) +
    labs(
      title    = titulo_variable,
      subtitle = glue("{info$subt}: norma alta vs baja"),
      x        = "Olas de seguimiento",
      y        = "Porcentaje (top-box 4–5)",
      caption  = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal()
}

# 11) COMPARACIONES DENTRO DE GRUPO (líneas / barras) ---------------------------

plot_comparacion_dentro_grupo_line <- function(variables,
                                               grupo = "Indígena",
                                               titulo = NULL,
                                               min_n = 20,
                                               ci = FALSE) {
  variables <- validar_vars(variables)
  if (is.null(titulo)) titulo <- glue("Comparación dentro del grupo: {grupo}")
  
  df <- panel_data %>% filter(cat_indi == grupo)
  
  tendencias <- purrr::map_dfr(variables, ~{
    tmp <- agg_pct_top(df, .x, min_n = min_n)
    if (nrow(tmp) == 0) return(tmp)
    tmp$variable <- factor(.x,
                           levels = variables,
                           labels = purrr::map_chr(variables, label_var))
    tmp
  })
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  
  tendencias <- tendencias %>% mutate(x_num = as.numeric(fecha_ola))
  
  last_lvl_chr <- levels(tendencias$fecha_ola)[length(levels(tendencias$fecha_ola))]
  labels_mid <- dplyr::filter(tendencias, as.character(fecha_ola) != last_lvl_chr)
  end_lab <- tendencias %>%
    dplyr::filter(as.character(fecha_ola) == last_lvl_chr) %>%
    dplyr::group_by(variable) %>% dplyr::slice_tail(n = 1) %>% dplyr::ungroup()
  
  ggplot(tendencias,
         aes(x = x_num, y = porcentaje, group = variable, color = variable)) +
    (if (ci)
      geom_ribbon(aes(ymin = lo, ymax = hi, fill = variable),
                  alpha = 0.15, colour = NA) else NULL) +
    geom_line(linewidth = 1.6, lineend = "round") +
    geom_point(size = 3) +
    geom_text(data = labels_mid,
              aes(label = paste0(round(porcentaje), "%")),
              vjust = -0.6, size = 4, show.legend = FALSE) +
    geom_text(data = end_lab,
              aes(x = max(tendencias$x_num),
                  y = porcentaje,
                  label = paste0(round(porcentaje), "%")),
              inherit.aes = FALSE,
              hjust = -0.1, vjust = 0.5,
              size = 4.2, fontface = "bold") +
    scale_x_continuous(
      breaks = sort(unique(tendencias$x_num)),
      labels = levels(tendencias$fecha_ola)
    ) +
    scale_y_continuous(
      labels = \(x) paste0(x, "%"),
      limits = c(0, 100),
      breaks = seq(0, 100, 20),
      expand = expansion(mult = c(0.04, 0.12))
    ) +
    labs(
      title = titulo,
      subtitle = glue("Comparación dentro del grupo: {grupo}"),
      x = "Olas de seguimiento",
      y = "Porcentaje (top-box 4–5)",
      caption = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal() +
    theme(legend.title = element_blank())
}

plot_comparacion_dentro_grupo_bar <- function(variables,
                                              grupo = "Indígena",
                                              titulo = NULL,
                                              min_n = 20) {
  variables <- validar_vars(variables)
  if (is.null(titulo)) titulo <- glue("Comparación dentro del grupo: {grupo}")
  
  df <- panel_data %>% filter(cat_indi == grupo)
  
  tendencias <- purrr::map_dfr(variables, ~{
    tmp <- agg_pct_top(df, .x, min_n = min_n)
    if (nrow(tmp) == 0) return(tmp)
    tmp$variable <- factor(.x,
                           levels = variables,
                           labels = purrr::map_chr(variables, label_var))
    tmp
  })
  if (nrow(tendencias) == 0) { warning("Sin datos suficientes."); return(NULL) }
  
  ggplot(tendencias,
         aes(x = fecha_ola, y = porcentaje, fill = variable)) +
    geom_col(position = position_dodge(width = 0.8),
             color = "white", width = 0.7) +
    geom_text(aes(label = paste0(round(porcentaje), "%")),
              position = position_dodge(width = 0.8),
              vjust = -0.6, size = 4, fontface = "bold") +
    scale_y_continuous(
      labels = \(x) paste0(x, "%"),
      limits = c(0, 100),
      breaks = seq(0, 100, 20),
      expand = expansion(mult = c(0, 0.05))
    ) +
    labs(
      title = titulo,
      subtitle = glue("Comparación dentro del grupo: {grupo}"),
      x = "Olas de seguimiento",
      y = "Porcentaje (top-box 4–5)",
      fill = "Ítem",
      caption = CAPTION_FUENTE
    ) +
    theme_esep_longitudinal()
}


```

## 

> ::: {style="text-align:center; font-style:italic; color:#6B4E3D; font-size:1.4em;"}
> Confianza, Apoyo a Políticas Públicas y Justificación de la Violencia\
> <br> [La presentación se organiza en módulos que permiten observar, a lo largo del tiempo, las diferencias y convergencias entre personas indígenas y no indígenas.]{style="font-size:0.7em; color:#556B2F; font-style:italic;"}
> :::

## Preliminares

```{r}
#| label: ficha-tecnica-elri
#| out-width: 100%
#| echo: false

pacman::p_load(tidyverse, gt)

ft <- tribble(
  ~Aspecto, ~Detalle,

  # Identidad del estudio
  "Nombre del estudio", "ELRI — Estudio Longitudinal de Relaciones Interculturales.",
  "Tipo de estudio", "Panel longitudinal de **panel fijo repetido** (contacto aprox. cada 18–24 meses).",
  "Olas de medición", "Ola 1: **2016** · Ola 2: **2018** · Ola 3: **2021** · Ola 4: **2023**.",

  # Ámbito y unidades
  "Ámbito geográfico / Universo",
  "Población **urbana y rural** de 18 años y más en 3 macrozonas del país:
   Norte (Arica y Parinacota, Tarapacá, Antofagasta),
   Centro (Región Metropolitana) y
   Sur (Biobío, La Araucanía, Los Ríos, Los Lagos).",
  "Unidad de análisis", "Individuos (personas de 18+ residentes en Chile).",

  # Diseño muestral
  "Diseño muestral",
  "**Muestra espejo** (indígena / no indígena) seleccionada en las **mismas manzanas o entidades rurales**,
   con **sobre-representación** de población indígena (rare population sampling).",
  "Representatividad", "El estudio **no es representativo** de la población nacional. Ajuste con ponderadores",

  # Trabajo de campo / modo / ejecutores
  "Modo de aplicación por ola",
  "O1 2016–17: **presencial** · O2 2018–19: **presencial** · O3 2020–21: **telefónica (CATI)** · O4 2022–23: **presencial**.",

  # Tamaños (según ficha)
  "Tamaño muestral por ola",
  "O1: **3617** · O2: **2879** · O3: **2881** · O4: **2310**.",
  "Seguimiento panel",
  "**1680** participaron en todas las olas",

  # Ética
  "Ética",
  "Aprobación del Comité Ético Científico de la Pontificia Universidad Católica de Chile (2016) con renovación en 2023."
)

fs <- 21
ft |>
  gt() |>
  cols_label(Aspecto = "Aspecto", Detalle = "Detalle") |>
  fmt_markdown(columns = c(Aspecto, Detalle)) |>
  cols_width(Aspecto ~ pct(28), Detalle ~ pct(72)) |>
  tab_style(style = cell_text(weight = "bold"),
            locations = cells_body(columns = Aspecto)) |>
  tab_style(style = cell_text(whitespace = "normal"),
            locations = list(cells_body(columns = Aspecto),
                             cells_body(columns = Detalle))) |>
  cols_align("left", everything()) |>
  opt_row_striping() |>
  opt_vertical_padding(scale = 1.2) |>
  tab_options(
    table.layout = "auto",
    table.width  = pct(100),
    data_row.padding = px(10),
    table.font.size = px(fs),
    column_labels.font.size = px(fs + 2),
    heading.title.font.size = px(fs + 6),
    heading.align = "left"
  )

```

# 

![](images/alluvial.png){fig-align="center"}

# Identidad

# 

```{r}
plot_variable_por_indigeneidad_line("a4") +
  labs(
    caption = "Para muestra No Indígena no se preguntó para el año 2016"
  )


```

#

```{r}
plot_variable_por_indigeneidad_line("a6")

```


#

```{r}
# 5) Comparar identificación con Chile vs pueblos originarios dentro de indígenas
plot_comparacion_dentro_grupo_bar(
  c("a4","a6"),
  grupo  = "Indígena",
  titulo = "Identificación"
) +
  scale_fill_brewer(palette = "Set1") 



```

#

```{r}
plot_comparacion_dentro_grupo_bar(
  c("a4","a6"),
  grupo  = "No indígena",
  titulo = "Identificación"
) +
  scale_fill_brewer(palette = "Set1") 


```



--

# Apoyo a políticas públicas

#

```{r}
plot_variable_por_indigeneidad_line(
  variable       = "e4_5",
  titulo_variable = "Escaños reservados indígenas en el Congreso",
  ci             = FALSE,
  min_n          = 20
)

```

#

```{r}
plot_variables_por_indigeneidad_line(
  variables = c("e3_2", "e4_5"),
  titulo    = "Apoyo a demandas",
  ci        = FALSE,
  min_n     = 20,
  ncol      = 2
)

```





#

```{r}
plot_variable_por_contacto_line(
  variable     = "e4_5",
  contacto     = "outgroup",      # para No indígenas = contacto con indígenas
  grupo_filtro = "No indígena",
  titulo_variable = "Escaños reservados según contacto con indígenas (No indígenas)",
  min_n        = 20,
  ci           = FALSE
)

```


#

```{r}
plot_variable_por_contacto_line(
  variable     = "e4_5",
  contacto     = "outgroup",      # para No indígenas = contacto con indígenas
  grupo_filtro = "No indígena",
  titulo_variable = "Escaños reservados según contacto con indígenas (No indígenas)",
  min_n        = 20,
  ci           = FALSE
)
```

#

```{r}
plot_variable_por_contacto_line(
  variable     = "e4_5",
  contacto     = "outgroup",
  grupo_filtro = "Indígena",
  titulo_variable = "Escaños reservados según contacto con no indígenas (Indígenas)",
  min_n        = 20
)
```

#

```{r}
plot_comparacion_dentro_grupo_line(
  variables = c( "e3_2", "e4_4"),
  grupo     = "Indígena",
  titulo    = "Reconocimiento político y redistributivo dentro del grupo indígena",
  min_n     = 20,
  ci        = FALSE
)
```

#

```{r}

plot_comparacion_dentro_grupo_line(
  variables = c( "e3_2", "e4_4"),
  grupo     = "No indígena",
  titulo    = "Reconocimiento político y redistributivo dentro del grupo indígena",
  min_n     = 20,
  ci        = FALSE
)

```

#

```{r}
plot_comparacion_dentro_grupo_bar(
  variables = c("e3_2", "e4_4"),
  grupo     = "No indígena",
  titulo    = "Reconocimiento político y redistributivo dentro del grupo no indígena",
  min_n     = 20
)
```

#

```{r}

plot_comparacion_dentro_grupo_bar(
  variables = c("e3_2", "e4_4"),
  grupo     = "Indígena",
  titulo    = "Reconocimiento político y redistributivo dentro del grupo no indígena",
  min_n     = 20
)
```



# Confianza

# Violencia
